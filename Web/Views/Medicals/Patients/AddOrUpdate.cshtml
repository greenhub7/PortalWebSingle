@model Web.Models.PatientView
@{
    ViewBag.Title = Model.PatientId == 0 ? "Registrar Nuevo Paciente" : "Modificar Paciente";
}
 
<style>
    .form-section { 
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 0.75rem;
    }

    .section-title {
        color: #2c3e50;
        border-bottom: 2px solid #3498db;
        padding-bottom: 0.25rem;
        margin-bottom: 1rem;
        font-size: 1.1rem;
    }

    .radio-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .radio-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .required-field::after {
        content: "*";
        color: red;
        margin-left: 4px;
    }

    .optional-field::after {
        content: "(*)";
        color: green;
        margin-left: 4px;
    }

    .form-control[readonly] {
        background-color: #f8f9fa !important;
        border: 2px dashed #ced4da !important;
        color: #6c757d !important;
        cursor: not-allowed !important;
        opacity: 0.85;
        font-style: italic;
    }

    .form-control:disabled {
        background-color: #f8f9fa !important;
        border: 2px dashed #ced4da !important;
        color: #6c757d !important;
        cursor: not-allowed !important;
        opacity: 0.85;
        font-style: italic;
    }

    
    .readonly-field-wrapper {
        position: relative;
    }

    .readonly-field-wrapper .lock-icon {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        pointer-events: none;
        font-size: 14px;
    }
    
    
    select.form-control,
    select.form-select,
    input[type="checkbox"],
    input[type="radio"],
    .PsDates,
    .form-check-input {
        cursor: pointer !important;
    }
     
 

    @@media (max-width: 768px) {
        .form-section {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .section-title {
            font-size: 1rem;
            margin-bottom: 0.75rem;
        }

        .col-form-label {
            margin-bottom: 0.25rem;
        }

        .mb-3 {
            margin-bottom: 0.75rem !important;
        }

     

     

    
        .radio-group {
            gap: 0.25rem;
        }
    }
     
    .required-field input:not(:focus):invalid {
        border-color: #dc3545;
    }

    .required-field input:not(:focus):invalid + .invalid-feedback {
        display: block;
    }

    .invalid-feedback {
        display: none;
        width: 100%;
        margin-top: .25rem;
        font-size: .875em;
        color: #dc3545;
    }
</style>

@using (Html.BeginForm("AddOrUpdate", "Patients", FormMethod.Post, new { enctype = "multipart/form-data", id = "patientForm" }))
{
    @Html.AntiForgeryToken()

  
        @Html.HiddenFor(model => model.AuthorId)
    

    @Html.HiddenFor(model => model.StatusId)
    @Html.HiddenFor(model => model.PersonId)
    @Html.HiddenFor(model => model.PatientId)
    @Html.HiddenFor(model => model.Imagen)
    @Html.HiddenFor(model => model.CreationDate)
    @Html.HiddenFor(model => model.Record)
    @Html.HiddenFor(model => model.UserId)
    @Html.HiddenFor(model => model.ConfirmationSave)

        <div class="container-fluid">

            <div class="form-section">
                <h4 class="section-title">Información del Paciente</h4>

           

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="required-field">Número de Expediente</label>
                        <div class="readonly-field-wrapper">
                            @Html.TextBoxFor(m => m.Record2, new { @class = "form-control", @readonly = "readonly", @title = "Este campo se genera automáticamente" })
                            <i class="bi bi-lock-fill lock-icon" title="Campo bloqueado - Se genera automáticamente"></i>
                        </div>
                        @Html.ValidationMessageFor(m => m.Record2, "", new { @class = "text-danger" })
                    </div>
                    <div class="col-md-4 mb-3">
                        <label>Tipo de Sangre</label>
                        <div class="radio-group">
                            @{
                                var bloodTypes = ViewBag.BloodTypes as SelectList;
                                if (bloodTypes != null)
                                {
                                    foreach (SelectListItem bloodType in bloodTypes)
                                    {
                                        <div class="radio-item">
                                            <input type="radio" id="blood_@bloodType.Value" name="BloodTypeId"
                                                   value="@bloodType.Value" @(Model.BloodTypeId.ToString() == bloodType.Value ? "checked" : "") />
                                            <label for="blood_@bloodType.Value">@bloodType.Text</label>
                                        </div>
                                    }
                                }
                            }
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="optional-field">Número de Expediente Fisico Anterior</label>
                        @Html.TextBoxFor(m => m.Record3, new { @class = "form-control" })
                        @Html.ValidationMessageFor(m => m.Record3, "", new { @class = "text-danger" })
                    </div>
                </div>
           
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="required-field">Cédula</label>
                        @Html.TextBoxFor(m => m.Rnc, new { @class = "form-control", required = "required" })
                        <div class="invalid-feedback">La cédula es requerida</div>
                        @Html.ValidationMessageFor(m => m.Rnc, "", new { @class = "text-danger" })
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="required-field">Nombre</label>
                        @Html.TextBoxFor(m => m.Name, new { @class = "form-control", required = "required" })
                        <div class="invalid-feedback">El nombre es requerido</div>
                        @Html.ValidationMessageFor(m => m.Name, "", new { @class = "text-danger" })
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="required-field">Apellido</label>
                        @Html.TextBoxFor(m => m.LastName, new { @class = "form-control", required = "required" })
                        <div class="invalid-feedback">El apellido es requerido</div>
                        @Html.ValidationMessageFor(m => m.LastName, "", new { @class = "text-danger" })
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="optional-field">Cédula del Acompañante o Tutor</label>
                        @Html.TextBoxFor(m => m.CompanionRnc, new { @class = "form-control" })
                        @Html.ValidationMessageFor(m => m.CompanionRnc, "", new { @class = "text-danger" })
                    </div>
                    <div class="col-md-8 mb-3">
                        <label class="optional-field">Nombre del Acompañante o Tutor</label>
                        @Html.TextBoxFor(m => m.Companion, new { @class = "form-control" })
                        @Html.ValidationMessageFor(m => m.Companion, "", new { @class = "text-danger" })
                    </div>
                </div>
           
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="optional-field">Fecha de Nacimiento</label>
                        <div class="input-group">
                            @Html.TextBoxFor(m => m.BornDateStr, new {
                                @class = "form-control PsDates",
                                type = "text",
                                autocomplete = "off",
                                @Value = Model.BornDateStr ?? ""
                            })
                            @Html.ValidationMessageFor(m => m.BornDateStr, "", new { @class = "text-danger" })
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label>Edad</label>
                        <div class="input-group">
                            @Html.TextBoxFor(m => m.Age, new { @class = "form-control", @readonly = "readonly" })
                            <div class="input-group-append">
                                <div class="input-group-text">
                                    <input type="checkbox" id="manualAge" value="true"> Edad Manual
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="required-field">Género</label>
                        <div class="radio-group">
                            @{
                                var genders = ViewBag.Genders as SelectList;
                                if (genders != null)
                                {
                                    foreach (SelectListItem gender in genders)
                                    {
                                        <div class="radio-item">
                                            <input type="radio" id="gender_@gender.Value" name="GenderId" required
                                                   value="@gender.Value" @(Model.GenderId.ToString() == gender.Value ? "checked" : "") />
                                            <label for="gender_@gender.Value">@gender.Text</label>
                                        </div>
                                    }
                                }
                            }
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <label>Etnia</label>
                        <div class="radio-group">
                            @foreach (var ethnicity in Enum.GetValues(typeof(Domain.Enums.Ethnicity)))
                            {
                                <div class="radio-item">
                                    <input type="radio" id="ethnicity_@((int)ethnicity)" name="EthnicityId" 
                                           value="@((int)ethnicity)" @(Model.EthnicityId == (Domain.Enums.Ethnicity)ethnicity ? "checked" : "") />
                                    <label for="ethnicity_@((int)ethnicity)">@ethnicity</label>
                                </div>
                            }
                        </div>
                    </div>
                
                    <div class="col-md-4 mb-3">
                        <label>País</label>
                        @Html.DropDownList("CountryId", null, new { @class = "form-control" })
                        @Html.ValidationMessageFor(m => m.CountryId, "", new { @class = "text-danger" })
                    </div>
                </div>
         
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Estado Civil</label>
                        <div class="radio-group">
                            @{
                                var maritalStatuses = ViewBag.MaritalSituations as SelectList;
                                if (maritalStatuses != null)
                                {
                                    foreach (SelectListItem status in maritalStatuses)
                                    {
                                        <div class="radio-item">
                                            <input type="radio" id="marital_@status.Value" name="MaritalSituationId" 
                                                   value="@status.Value" @(Model.MaritalSituationId.ToString() == status.Value ? "checked" : "") />
                                            <label for="marital_@status.Value">@status.Text</label>
                                        </div>
                                    }
                                }
                            }
                        </div>
                        <div class="mt-2">
                            <div class="form-check">
                                @Html.CheckBoxFor(m => m.LiveAlone, new { @class = "form-check-input" })
                                <label class="form-check-label">¿Vive Solo?</label>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <div class="row">
                           
                            <div class="col-md-6">
                                <label>Nivel Educativo</label>
                                <div class="radio-group">
                                    @{
                                        var schoolLevels = ViewBag.SchoolLevels as SelectList;
                                        if (schoolLevels != null)
                                        {
                                            foreach (SelectListItem level in schoolLevels)
                                            {
                                                <div class="radio-item">
                                                    <input type="radio" id="school_@level.Value" name="SchoolLevelId" 
                                                           value="@level.Value" @(Model.SchoolLevelId.ToString() == level.Value ? "checked" : "") />
                                                    <label for="school_@level.Value">@level.Text</label>
                                                </div>
                                            }
                                        }
                                    }
                                </div>
                            </div>
                            <div class="col-md-4 mt-2">
                                <label>Años en el último Nivel</label>
                                @Html.TextBoxFor(m => m.YearsInTheGreatestLevel, new { @class = "form-control", type = "number", min = "0" })
                                <div class="form-check">
                                    @Html.CheckBoxFor(m => m.LiveAlone, new { @class = "form-check-input" })
                                    <label class="form-check-label">¿Alfabeta?</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label>Ocupación</label>
                        @Html.DropDownList("OcupationId", null, new { @class = "form-control" })
                        @Html.ValidationMessageFor(m => m.OcupationId, "", new { @class = "text-danger" })
                    </div>
                    <div class="col-md-4 mb-3">
                        <label>Religión</label>
                        @Html.DropDownList("ReligionId", null, new { @class = "form-control" })
                        @Html.ValidationMessageFor(m => m.ReligionId, "", new { @class = "text-danger" })
                    </div>
                </div>
              

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="optional-field">Seguro</label>
                        @Html.DropDownList("InsuranceId", null, new { @class = "form-control" })
                        @Html.ValidationMessageFor(m => m.InsuranceId, "", new { @class = "text-danger" })
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="optional-field">Número de Seguro</label>
                        @Html.TextBoxFor(m => m.InsuranceNumber, new { @class = "form-control" })
                        @Html.ValidationMessageFor(m => m.InsuranceNumber, "", new { @class = "text-danger" })
                    </div>
                    <div class="col-md-4 mb-3">
                        <label>NSS</label>
                        @Html.TextBoxFor(m => m.Nss, new { @class = "form-control" })
                    </div>
                </div>

        
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="optional-field">
                            Teléfono 
                            <small class="text-muted">(ej: +18091234567, 8091234567)</small>
                        </label>
                        @Html.TextBoxFor(m => m.Tel, new { 
                            @class = "form-control phone-input", 
                            @type = "tel", 
                            @placeholder = "+1809123456789",
                            @data_phone_validation = "true",
                            @id = "Tel"
                        })
                        @Html.ValidationMessageFor(m => m.Tel, "", new { @class = "text-danger" })
                        <div class="phone-validation-message" id="tel-validation-message"></div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label>
                            Celular 
                            <small class="text-muted">(ej: +18291234567, 8291234567)</small>
                        </label>
                        @Html.TextBoxFor(m => m.Cel, new { 
                            @class = "form-control phone-input", 
                            @type = "tel", 
                            @placeholder = "+1829123456789",
                            @data_phone_validation = "true",
                            @id = "Cel"
                        })
                        @Html.ValidationMessageFor(m => m.Cel, "", new { @class = "text-danger" })
                        <div class="phone-validation-message" id="cel-validation-message"></div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label>Email</label>
                        @Html.TextBoxFor(m => m.Email, new { @class = "form-control" })
                        @Html.ValidationMessageFor(m => m.Email, "", new { @class = "text-danger" })
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="optional-field">Localidad</label>
                        @Html.TextBoxFor(m => m.Location, new { @class = "form-control"  })
                        @Html.ValidationMessageFor(m => m.Location, "", new { @class = "text-danger" })
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="optional-field">Dirección</label>
                        @Html.TextAreaFor(m => m.Address, new { @class = "form-control", rows = "2" })
                        @Html.ValidationMessageFor(m => m.Address, "", new { @class = "text-danger" })
                    </div>
                </div>
            </div>
             
            <div class="form-section">
                <h4 class="section-title">Información de Referencia</h4>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Médico que Refiere</label>
                        @Html.TextBoxFor(m => m.Doctor, new { @class = "form-control", autocomplete = "on" })
                        @Html.ValidationMessageFor(m => m.Doctor, "", new { @class = "text-danger" })
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Centro Clínico de Referencia</label>
                        @Html.TextBoxFor(m => m.Clinical, new { @class = "form-control", autocomplete = "on" })
                        @Html.ValidationMessageFor(m => m.Clinical, "", new { @class = "text-danger" })
                    </div>
                </div>
            </div>

        </div>
  
    ViewData["ReturnUrl"] = Url.Action("Index", "Patients");
    ViewData["FormId"] = "patientForm";
     
    <partial name="_btnSubmitAndCancel" />
}

@section Scripts {
    <script src="~/js/phone-validator.js"></script>
    <script>
        $(document).ready(function() {
            
            $("#Rnc, #CompanionRnc").mask("999-9999999-9");

            
            

            
            window.phoneValidator.setupLiveValidation('#Tel', '#tel-validation-message');
            window.phoneValidator.setupLiveValidation('#Cel', '#cel-validation-message');
              
            
            setTimeout(function() {
                const birthDateInput = document.querySelector('#BornDateStr');
                if (birthDateInput && birthDateInput._flatpickr) {
                    birthDateInput._flatpickr.set('maxDate', 'today');
                }
            }, 100);

            
            if ($('#BornDateStr').val()) {
                let ageWithUnit = getAgeWithUnit($('#BornDateStr').val());
                if (ageWithUnit !== '') {
                    $('#Age').val(ageWithUnit);
                }
            }

            
            $('#BornDateStr').on('change', function() {
                let dateValue = $(this).val();

                
                if (!dateValue || dateValue.includes('_')) {
                    return;
                }

                let ageWithUnit = getAgeWithUnit(dateValue);

                if (ageWithUnit !== '') {
                    $('#Age').val(ageWithUnit);
                } else {
                    
                    $('#Age').val('');
                }
            });

            
            $('#Age').attr('readonly', true);
            $('#manualAge').change(function() {
                if ($(this).is(":checked")) {
                    Swal.fire({
                        title: '¿Seguro?',
                        text: "¿Desea insertar una edad manual?",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Sí, permitir',
                        cancelButtonText: 'No, cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $('#Age').attr('readonly', false);
                            $('#BornDateStr').attr('readonly', true);
                            $('#BornDateStr').val('');
                        } else {
                            $(this).prop('checked', false);
                            $('#Age').attr('readonly', true);
                            $('#BornDateStr').attr('readonly', false);
                        }
                    });
                } else {
                    $('#Age').attr('readonly', true);
                    $('#BornDateStr').attr('readonly', false);
                }
            });
            $('input[required]').on('invalid', function(e) {
                e.preventDefault();
                $(this).addClass('is-invalid');
            });

            $('input[required]').on('input', function() {
                if (this.validity.valid) {
                    $(this).removeClass('is-invalid');
                }
            });

            $("#patientForm").on("submit", function(e) {
                e.preventDefault();

                var requiredFields = {
                    "Name": "Nombre",
                    "LastName": "Apellido"
                };

                if (!$("#Rnc").val() && !$("#CompanionRnc").val()) {
                    requiredFields["Rnc"] = "Cédula del paciente o del acompañante";
                }

                var missingFields = [];
                Object.keys(requiredFields).forEach(function(field) {
                    if (!$(`#${field}`).val()) {
                        missingFields.push(requiredFields[field]);
                        $(`#${field}`).addClass('is-invalid');
                    }
                });

                if ($("#InsuranceId").val() > 1 && !$("#CompanionRnc").val() && !$("#Rnc").val()) {
                    missingFields.push("Cédula del paciente o acompañante (requerida para seguro)");
                }

                if (missingFields.length > 0) {
                    Swal.fire({
                        title: '¿Desea continuar?',
                        html: `Los siguientes campos están vacíos:<br>${missingFields.join('<br>')}`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Sí, continuar',
                        cancelButtonText: 'No, revisar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $("#ConfirmationSave").val(true);
                            this.submit();
                        }
                    });
                } else {
                    this.submit();
                }
            });
        });

        function getAgeWithUnit(dateString) {
            let parts = dateString.split('/');
            if (parts.length !== 3) {
                return '';
            }

            let birthDate = new Date(parts[2], parts[1] - 1, parts[0]);

            if (isNaN(birthDate.getTime())) {
                return '';
            }

            let today = new Date();

            
            let diffMs = today - birthDate;

            
            let diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                return ''; 
            }

            
            if (diffDays < 28) {
                return diffDays + " días";
            }

            
            let diffMonths = Math.floor(diffDays / 30.44);

            
            if (diffMonths < 24) {
                return diffMonths + " meses";
            }

            
            let age = today.getFullYear() - birthDate.getFullYear();
            let monthDiff = today.getMonth() - birthDate.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }

            if (age > 130) {
                return ''; 
            }

            return age + " años";
        }
    </script>
}